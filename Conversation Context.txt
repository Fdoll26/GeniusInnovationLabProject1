Conversation Context:

  ———

  ## Project Summary (multi‑api‑test‑ground)

  ### What the app does

  A Next.js app (App Router) where signed‑in users submit a research topic,
  answer OpenAI‑generated clarifications, approve a rewritten prompt, then run
  OpenAI Deep Research + Gemini research, aggregate results, generate a PDF,
  email the report, and store session history.

  ### Key architecture

  - Next.js + React + TypeScript + NextAuth (Google provider)
  - PostgreSQL with schema + migrations
  - OpenAI + Gemini clients
  - PDF generation via pdf‑lib
  - Email via SendGrid

  ### Major fixes + changes done

  Auth / OAuth

  - NextAuth working; ensure Google OAuth redirect URI set:
    http://localhost:3000/api/auth/callback/google

  Debug / Dev bypass

  - Debug Panel on Home (dev only) with advanced toggles:
      - Stub: refiner, OpenAI, Gemini, Email, PDF
      - Skip: OpenAI, Gemini
      - Global stub: DEV_STUB_EXTERNALS
  - Query ?debug=1 auto‑enables bypass + stubs.
  - Debug endpoints:
      - /api/debug/bypass sets cookies
      - /api/debug/test-report sends test email with custom text
      - /api/debug/seed-session creates fake completed session

  Clarification flow

  - Clarification Q/A uses OpenAI refiner (Responses API).
  - Prompt rewrite added using refiner model.
  - “Review refined prompt” now uses rewritten prompt.
  - UI fixes: submitting hides input + shows spinner; approve hides panel.

  OpenAI Deep Research

  - Replaced fake /deep_research/* endpoints with Responses API.
  - Deep research now includes tool requirement:
    tools: [{ type: 'web_search_preview' }].
  - Configurable env vars:
      - OPENAI_REFINER_MODEL (default gpt-4.1-mini)
      - OPENAI_DEEP_RESEARCH_MODEL (default o3-deep-research)
      - OPENAI_MAX_TOOL_CALLS

  Gemini

  - Model configurable via GEMINI_MODEL (default gemini-1.5-pro-002)
  - GEMINI_API_BASE optional

  PDF generation

  - Updated PDF to wrap text + paginate to prevent clipping.

  Rate limits + access control

  - ALLOWED_EMAILS allowlist (comma‑separated) in authz.
  - Rate limiting added for create session, approve, retry:
      - RATE_LIMIT_WINDOW_SECONDS, RATE_LIMIT_MAX_REQUESTS
  - New migration: db/migrations/002_rate_limit.sql

  Dev UX

  - Status card has spinner + progress bar for active states.
  - Refinement panel shows spinner for “Saving answer…” and progress bar for
    “Generating refined prompt…”

  ### Important Files Added/Updated

  - app/lib/openai-client.ts (Responses API; refiner + rewrite + deep research)
  - app/lib/orchestration.ts
  - app/lib/debug.ts (async cookies)
  - app/lib/rate-limit.ts
  - app/lib/pdf-report.ts (wrap + paginate)
  - app/lib/authz.ts (allowlist)
  - app/api/debug/* routes
  - app/(research)/components/DebugPanel.tsx
  - app/(research)/components/RefinementPanel.tsx
  - app/(research)/components/SessionStatus.tsx
  - db/migrations/002_rate_limit.sql
  - .env.example sanitized (placeholder values)
  - README.md updated with debug + access + rate limit notes

  ### Setup / DB

  - Run migrations:

    psql "$DATABASE_URL" -f db/migrations/001_init.sql
    psql "$DATABASE_URL" -f db/migrations/002_rate_limit.sql
  - Seed data:

    psql "$DATABASE_URL" -f db/seed/seed.sql

  ### Env variables (key)

  DATABASE_URL=...
  NEXTAUTH_URL=http://localhost:3000
  NEXTAUTH_SECRET=...
  GOOGLE_CLIENT_ID=...
  GOOGLE_CLIENT_SECRET=...
  OPENAI_API_KEY=...
  OPENAI_API_BASE= (optional)
  OPENAI_REFINER_MODEL=gpt-4.1-mini
  OPENAI_DEEP_RESEARCH_MODEL=o3-deep-research
  OPENAI_MAX_TOOL_CALLS=
  GEMINI_API_KEY=...
  GEMINI_API_BASE= (optional)
  GEMINI_MODEL=gemini-1.5-pro-002
  SENDGRID_API_KEY=...
  EMAIL_FROM=...

  DEV_BYPASS_AUTH=false
  DEV_STUB_EXTERNALS=false
  DEV_STUB_REFINER=false
  DEV_STUB_OPENAI=false
  DEV_STUB_GEMINI=false
  DEV_STUB_EMAIL=false
  DEV_STUB_PDF=false
  DEV_SKIP_OPENAI=false
  DEV_SKIP_GEMINI=false

  ALLOWED_EMAILS=
  RATE_LIMIT_WINDOW_SECONDS=60
  RATE_LIMIT_MAX_REQUESTS=10

  ### Known issues / notes

  - Deep research model requires org verification; set
    OPENAI_DEEP_RESEARCH_MODEL to one you have access to.
  - Gemini quota errors can happen; use GEMINI_MODEL you’re allowed to call.
  - Debug panel helps bypass OAuth / stub API calls.

